#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

x=1
if git diff --cached --quiet -- "server/*.ts"; then
  echo "%=============================================================================================%"
  echo "= $x No .ts changes in Server (Skipping)"
  echo "%=============================================================================================%"
else 
  echo "%=============================================================================================%"
  echo "= $x Found changes in Server."
  echo "%=============================================================================================%"
  {
    echo "%=============================================================================================%"
    echo "= $x:A Linting Server..."
    echo "%=============================================================================================%"
    npm run lint:server
  } || {
    x=x+0.5
    echo "%=============================================================================================%"
    echo "= X You have eslint errors in Server. Please fix them before committing." 1>&2
    echo "%=============================================================================================%"
    false
  }

  echo "%=============================================================================================%"
  echo "= $x:B Formatting Server..."
  echo "%=============================================================================================%"
  npm run format:server

  x=$((x+1))
fi


if git diff --cached --name-only --quiet -- "client/*.ts"; then
  echo "%=============================================================================================%"
  echo "= $x No .ts changes in Client (Skipping)"
  echo "%=============================================================================================%"
else
  echo "%=============================================================================================%"
  echo "= $x Found changes in Client."
  echo "%=============================================================================================%"
  {
    echo "%=============================================================================================%"
    echo "= $x:A Linting Client..."
    echo "%=============================================================================================%"
    npm run lint:client
  } || {
    echo "%=============================================================================================%"
    echo "= X You have eslint errors in Client. Please fix them before committing." 1>&2
    echo "%=============================================================================================%"
    false
  }

  echo "%=============================================================================================%"
  echo "= $x:B Formatting Client..."
  echo "%=============================================================================================%"
  npm run format:client

  echo "%=============================================================================================%"
  echo "= $x:C Removing environment variables..."
  echo "%=============================================================================================%"
  npm run clean:env

  if git diff --name-only --quiet ./client/src/environments/*; then
    true
  else
    git add ./client/src/environments/* && git commit --amend --no-edit --no-verify
  fi
fi
